<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Photobooth AI</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #ffe6f2; }
        
        /* Container ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô Video ‡∏Å‡∏±‡∏ö Frame */
        #booth-container {
            position: relative;
            width: 320px; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö */
            height: 480px;
            margin: 0 auto;
            border: 5px solid #ff99cc;
            overflow: hidden;
            background: #000;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* ‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏£‡∏∞‡∏à‡∏Å */
        }

        #overlay-frame {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* ‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏∞‡∏•‡∏∏‡πÑ‡∏î‡πâ */
            z-index: 10;
        }

        .controls { margin-top: 20px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #ff66b2; color: white; border: none; border-radius: 20px; }
        
        #result-area { display: none; margin-top: 20px; }
        #qr-image { width: 150px; height: 150px; }
    </style>
</head>
<body>

    <h1>üì∏ K-Pop Style Photobooth</h1>

    <div id="booth-container">
        <video id="webcam" autoplay playsinline></video>
        <img id="overlay-frame" src="frames/frame1.png" alt="frame">
    </div>

    <div class="controls">
        <button onclick="changeFrame('frames/frame1.png')">‡∏Å‡∏£‡∏≠‡∏ö 1</button>
        <button onclick="changeFrame('frames/frame2.png')">‡∏Å‡∏£‡∏≠‡∏ö 2</button>
        <br><br>
        <button onclick="takePhoto()" style="font-size: 20px; background: #ff3366;">‡∏ñ‡πà‡∏≤‡∏¢‡πÄ‡∏•‡∏¢! (3‡∏ß‡∏¥)</button>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

    <div id="result-area">
        <h3>‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!</h3>
        <p>‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</p>
        <img id="qr-image" src="" alt="QR Code">
        <br>
        <a id="drive-link" href="#" target="_blank">‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</a>
    </div>

    <script>
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('canvas');
        const frameImg = document.getElementById('overlay-frame');
        
        // 1. ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á
        navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } })
            .then(stream => { video.srcObject = stream; })
            .catch(err => console.error("Camera error:", err));

        // 2. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏£‡∏≠‡∏ö
        function changeFrame(src) {
            frameImg.src = src;
        }

        // 3. ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
        function takePhoto() {
            let count = 3;
            const btn = document.querySelector('button[onclick="takePhoto()"]');
            
            const timer = setInterval(() => {
                btn.innerText = `... ${count}`;
                count--;
                if (count < 0) {
                    clearInterval(timer);
                    btn.innerText = "‡∏ñ‡πà‡∏≤‡∏¢‡πÄ‡∏•‡∏¢! (3‡∏ß‡∏¥)";
                    captureAndUpload();
                }
            }, 1000);
        }

        // 4. ‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
        function captureAndUpload() {
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ç‡∏ô‡∏≤‡∏î Canvas ‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö Video ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏à‡∏£‡∏¥‡∏á
            const width = video.videoWidth;
            const height = video.videoHeight;
            
            // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô ‡πÉ‡∏´‡πâ fix size ‡∏ï‡∏≤‡∏°‡∏Å‡∏£‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏ä‡πà‡∏ô 1080x1920
            // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏≠‡∏≤‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠
            canvas.width = 320 * 2; // ‡∏Ñ‡∏π‡∏ì 2 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î (Retina)
            canvas.height = 480 * 2;
            
            const ctx = canvas.getContext('2d');

            // ‡∏ß‡∏≤‡∏î‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ (‡∏ï‡πâ‡∏≠‡∏á flip ‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤ flip css ‡πÑ‡∏ß‡πâ)
            ctx.save();
            ctx.scale(-1, 1);
            ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
            ctx.restore();

            // ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≠‡∏ö‡∏ó‡∏±‡∏ö‡∏•‡∏á‡πÑ‡∏õ
            ctx.drawImage(frameImg, 0, 0, canvas.width, canvas.height);

            // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Data URL
            const dataURL = canvas.toDataURL('image/png');

            // ‡∏™‡πà‡∏á‡πÑ‡∏õ Backend
            fetch('/upload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: dataURL })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    document.getElementById('result-area').style.display = 'block';
                    document.getElementById('qr-image').src = data.qrCode;
                    document.getElementById('drive-link').href = data.link;
                    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                } else {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î');
                }
            });
        }
    </script>
</body>
</html>
